# for1cRetail
фиксДляУтм4 расширение для конфигурации Розница (базовая), редакция 2.2 (2.2.13.12) позволяет
продавать через УТМ4. Фикс коснулся одной процедуры модуля ИнтеграцияЕГАИСКлиентСервер

сама процедура:

&Вместо("ПараметрыHTTPЗапроса")
Функция ПараметрыHTTPЗапроса4(ТекстСообщенияXML, АдресЗапроса) Экспорт
	
	аа = ИнтеграцияЕГАИСВызовСервера.НастройкиОбменаЕГАИС();
	для каждого пп из аа.ОбменНаКлиенте цикл
		
		АдресУТМ = пп.значение.АдресУТМ;
		портУТМ = пп.значение.портУТМ;
		прервать;
		
	конецЦикла;
		
	попытка
		
		ФайлОтвета 		= ПолучитьИмяВременногоФайла("xml");
		СерверЗапроса 	= АдресУТМ+":"+формат(портУТМ,"ЧГ=0");
		Соединение 		= Новый HTTPСоединение(СерверЗапроса,,,,,5); 
		а 				= Соединение.Получить("/info/version",ФайлОтвета);
		ЧтениеОтвета 	= новый текстовыйДокумент;
		ЧтениеОтвета.прочитать(ФайлОтвета,кодировкаТекста.UTF8);
		запросВерсииУТМ = ЧтениеОтвета.ПолучитьТекст();
		
	исключение
		
		запросВерсииУТМ = "";
		
	конецПопытки;
	
	если лев(запросВерсииУТМ,2) = "4." тогда
		
		Параметры 	= СтруктураДанныхHTTPЗапроса("POST");
		типЗ 		= "TransferToShop";
		ВремГраница = СтрЗаменить(Новый УникальныйИдентификатор, "-", "");
		Boundary 	= ВремГраница;
	    ТелоЗапроса = Новый ТекстовыйДокумент();
	    ТелоЗапроса.РазделительСтрок = Символы.CR+Символы.LF;
	    ТелоЗапроса.ДобавитьСтроку("--" + ВремГраница);
	    ТелоЗапроса.ДобавитьСтроку("Content-Disposition: form-data; name=""xml_file""; filename="+типЗ+"123.xml");
	    ТелоЗапроса.ДобавитьСтроку("Content-Type: text/xml; charset=utf-8");
	    ТелоЗапроса.ДобавитьСтроку("");
	    ТелоЗапроса.ДобавитьСтроку(ТекстСообщенияXML);
	    ТелоЗапроса.ДобавитьСтроку("--" + ВремГраница + "--");
	    ТелоЗапросаСтрока = ТелоЗапроса.ПолучитьТекст();
		стрЗапроса = ТелоЗапросаСтрока;
		
		Заголовки = Новый Соответствие();
		Параметры.Заголовки.Вставить("Content-Type", "multipart/form-data; boundary=" + Boundary);
		Параметры.АдресЗапроса = АдресЗапроса;
		Параметры.ТелоЗапроса  = ТелоЗапроса.ПолучитьТекст();
		Параметры.ТекстXML     = ТекстСообщенияXML;
		
	иначе
		
		Параметры = СтруктураДанныхHTTPЗапроса("POST");
	
		ВремГраница = СтрЗаменить(Строка(Новый УникальныйИдентификатор()), "-", "");
		
		ТелоЗапроса = Новый ТекстовыйДокумент();
		ТелоЗапроса.ДобавитьСтроку("--" + ВремГраница);
		ТелоЗапроса.ДобавитьСтроку("Content-Disposition: form-data; name=""xml_file""");
		ТелоЗапроса.ДобавитьСтроку("Content-Type: text/xml; charset=utf-8");
		ТелоЗапроса.ДобавитьСтроку("");
		ТелоЗапроса.ДобавитьСтроку(ТекстСообщенияXML);
		ТелоЗапроса.ДобавитьСтроку("--" + ВремГраница + "--");
		
		Параметры.АдресЗапроса = АдресЗапроса;
		Параметры.ТелоЗапроса  = ТелоЗапроса.ПолучитьТекст();
		Параметры.ТекстXML     = ТекстСообщенияXML;
		
		Параметры.Заголовки.Вставить("Content-Type", "multipart/form-data; boundary=" + ВремГраница);
		
		Возврат Параметры;

		
	конецЕсли;	
	
	Возврат Параметры;
	
КонецФункции //ПараметрыHTTPЗапроса
